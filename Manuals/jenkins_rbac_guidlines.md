# Connecting Jenkins to Kubernetes Cluster

## Step 1: Create Service Account in Kubernetes
1. **Create the `jenkins` Service Account:**
```bash
kubectl create namespace webapps
kubectl create serviceaccount jenkins -n webapps
```

2. **Create a ClusterRoleBinding:**
```bash
kubectl create clusterrolebinding jenkins-admin --clusterrole=cluster-admin --serviceaccount=webapps:jenkins
```

## Step 2: Generate a Token with 30-day Expiry
1. **Create the Token:** (Requires Kubernetes v1.24+)
```bash
kubectl create token jenkins --namespace webapps --duration=720h
```
Note: `720h` is equivalent to 30 days.

## Step 3: Retrieve the CA Certificate and API Server URL
1. **Get the CA Certificate:**
```bash
kubectl get secret $(kubectl get sa jenkins -n webapps -o jsonpath='{.secrets[0].name}') -n webapps -o jsonpath='{.data.ca\.crt}' | base64 -d > k8s-ca.crt
```
2. **Get API Server URL:**
```bash
kubectl cluster-info | grep 'Kubernetes control plane' | awk '/https/ {print $NF}'
```

## Step 4: Configure Jenkins to Access Kubernetes
1. **Transfer `k8s-ca.crt` to Jenkins Server:**
```bash
scp k8s-ca.crt eric@jenkins:/home/eric/
```

2. **Import the CA Certificate to Jenkins' Java Keystore inside jenkins server:**
```bash
sudo keytool -import -trustcacerts -keystore $(sudo find /usr/lib/jvm -name "cacerts") -storepass changeit -noprompt -alias k8s-cluster -file /home/eric/k8s-ca.crt
```

3. **Install the Kubernetes Plugin in Jenkins:**
- Go to Jenkins: **Manage Jenkins > Plugins > Available Plugins** and install the **Kubernetes** plugin.

4. **Configure Kubernetes Cloud in Jenkins:**
- Go to: **Manage Jenkins > Configure System > Cloud > Kubernetes**.
- Set the following:
  - **Kubernetes URL:** `https://<K8S_API_SERVER>:6443`
  - **Jenkins URL:** `http://<JENKINS_SERVER>:8080`
  - **Credentials:** Add new **Secret text**, name the ID **k8-token** and add credentials the token generated earlier.
  - **Test Connection** — Ensure it connects successfully.

5. **Save and Apply Settings.** 🎉

Jenkins is now connected to your Kubernetes cluster! Let me know if you’d like to dive into automating deployments next. 🚀

## 👨‍💻 Author

Generated by [@Eric mwakazi](https://www.linkedin.com/in/eric-mwakazi)  – Automating cloud-native infrastructure in homelabs and production.