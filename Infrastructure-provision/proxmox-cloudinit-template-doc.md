
# üì¶ Proxmox Cloud-Init Template Creation Script

This script automates the setup of a **Cloud-Init-ready Ubuntu 24.04 VM** on a Proxmox VE host. It handles:

- Enabling `snippets` support on local storage
- Creating a Cloud-Init YAML snippet (`vendor.yaml`)
- Creating a QEMU VM template from a cloud image
- Injecting custom user data, network config, host mappings, and users
- Booting, provisioning, and finalizing the Cloud-Init template

---

## üßæ Script Structure: `cloudinitVM.sh`

### 1. **Configuration Variables**

```bash
VM_ID="8002"
VM_NAME="ubuntu-2404-cloudinit-template"
CLOUD_IMAGE="/var/lib/vz/template/iso/jammy-server-cloudimg-amd64.img"
CI_USER="eric"
CI_PASSWORD="1234"
SSH_KEYS="$HOME/.ssh/authorized_keys"
```

These define the ID, name, image, user credentials, and SSH key used in the template VM.

> ‚úÖ **Edit these to suit your environment.**

---

### 2. **Enable `snippets` in Proxmox**

If the `local` storage doesn't support `snippets`, the script patches `/etc/pve/storage.cfg`:

```bash
sed -i "/$STORAGE_NAME/,/content/ s/\(content .*iso.*\)/\1,snippets/" "$CONFIG_FILE"
```

This allows injecting YAML cloud-init files into the VM config.

---

### 3. **Create Cloud-Init YAML Snippet**

`/var/lib/vz/snippets/vendor.yaml` is written with:

- **Essential packages** (like `qemu-guest-agent`, `curl`)
- Custom **`/etc/hosts` entries** for your K8s nodes
- Custom **DNS resolvers**
- User `kirui` with hashed password and user groups

```yaml
users:
  - name: kirui
    groups: admingroup
    passwd: <hashed-password>
```

> üîê You can **change or add users** here. Hash passwords using:
> ```bash
> openssl passwd -6 'yourpassword'
> ```

---

### 4. **Create and Configure Proxmox VM**

```bash
qm create $VM_ID --name "$VM_NAME" --ostype l26 ...
qm importdisk $VM_ID $CLOUD_IMAGE $STORAGE_POOL
qm set $VM_ID --scsi1 $STORAGE_POOL:cloudinit
```

- Disk resized to `12G`
- Cloud-Init disk attached
- BIOS/UEFI configured
- Hostname and password injected
- SSH keys added

---

### 5. **Boot, Wait, Finalize**

```bash
qm start $VM_ID
sleep 180
qm stop $VM_ID
qm set "$VM_ID" --delete scsi1
```

- The VM boots, runs cloud-init, updates, installs packages
- The script waits (`sleep 180`) then stops and finalizes the VM

---

## üõ†Ô∏è How to Edit for Your Environment

| Parameter        | Description                                      | Suggested Edit                         |
|------------------|--------------------------------------------------|----------------------------------------|
| `VM_ID`          | Unique Proxmox VM ID                             | Use a free ID like `8001`, `9000`      |
| `VM_NAME`        | Template name in Proxmox                         | Change to your naming convention       |
| `CLOUD_IMAGE`    | Path to Ubuntu cloud image                       | Download and place in `/var/lib/vz/...`|
| `CI_USER`        | Default cloud-init login user                    | Change to your username                |
| `CI_PASSWORD`    | Password for `CI_USER` (plaintext)               | Change or securely prompt              |
| `SSH_KEYS`       | Your public key path                             | Defaults to `~/.ssh/authorized_keys`   |
| `vendor.yaml`    | Inject custom setup                              | Add users, software, networking configs|

---

## üöÄ How to Run

### 1. Make Executable

```bash
chmod +x cloudinitVM.sh
```

### 2. Run as Root (or with sudo)

```bash
sudo ./cloudinitVM.sh
```

### 3. Verify on Proxmox

- Log into the Proxmox UI
- VM with name like `ubuntu-2404-cloudinit-template` will appear
- Boot it ‚Äî it‚Äôll come preconfigured with `/etc/hosts`, DNS, and your user!

---

## üß∞ Prerequisites

- Proxmox VE with local and local-lvm storages
- Cloud image downloaded (e.g., `jammy-server-cloudimg-amd64.img`)
- `qemu-guest-agent` installed inside VM
- SSH keys available for injection

---

## üí° Tips

- Use this VM as a **template** for further clones.
- Clone using `qm clone` and use `--full` for full copies or `--linked` for fast clones.
- Customize further using advanced cloud-init like:
  - Mount volumes
  - Run Ansible post-deploy
  - Join to cluster or install K3s

---

## üß™ Example: Clone and Set IP

```bash
qm clone 8002 101 --name k8s-master-01
qm set 101 --ipconfig0 ip=192.168.1.10/24,gw=192.168.1.1
qm start 101
```

---

## üôå Credits

- Built for homelab Kubernetes & DevOps automation
- Created by [Your Name] using Proxmox + Cloud-Init
## üë®‚Äçüíª Author

Generated by [@Emmanuel Kirui](https://www.linkedin.com/in/emmanuel-kirui/) ‚Äì Automating cloud-native infrastructure in homelabs and production.